---

name: molecule-ci

on:
  workflow_call:
    inputs:
      scenario_name:
        description: Scenario to run for this molecule test
        type: string
        required: true
      cleanup:
        description: Remove a bunch of preinstalled tools and libraries
        type: boolean
        required: false
        default: false
    secrets:
      env_secrets:
        description: Custom environment setup for molecule test run
        required: false

env:
  PYTHON_VERSION: "3.12"

permissions:
  contents: read

jobs:
  molecule-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Show disk usage
        if: ${{ inputs.cleanup }}
        run: df -h

      - name: Aggressive cleanup
        if: ${{ inputs.cleanup }}
        run: |
          # Remove Java (JDKs)
          sudo rm -rf /usr/lib/jvm

          # Remove .NET SDKs
          sudo rm -rf /usr/share/dotnet

          # Remove Swift toolchain
          sudo rm -rf /usr/share/swift

          # Remove Haskell (GHC)
          sudo rm -rf /usr/local/.ghcup

          # Remove Julia
          sudo rm -rf /usr/local/julia*

          # Remove Android SDKs
          sudo rm -rf /usr/local/lib/android

          # Remove Chromium (optional if not using for browser tests)
          sudo rm -rf /usr/local/share/chromium

          # Remove Microsoft/Edge and Google Chrome builds
          sudo rm -rf /opt/microsoft /opt/google

          # Remove Azure CLI
          sudo rm -rf /opt/az

          # Remove PowerShell
          sudo rm -rf /usr/local/share/powershell

          # Remove CodeQL and other toolcaches
          sudo rm -rf /opt/hostedtoolcache

          docker system prune -af || true
          docker builder prune -af || true
          df -h

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Install Ansible dependencies
        run: |
          if [ -f requirements.yml ]; then ansible-galaxy install -r requirements.yml; fi

      - name: Check for submodules and install dependencies
        shell: bash
        run: |
          # Initialize and update submodules if .gitmodules exists
          if [ -f .gitmodules ]; then
            git submodule update --init --recursive
            # Extract submodule paths from .gitmodules
            SUBMODULE_PATHS=$(git config --file .gitmodules --get-regexp path | awk '{ print $2 }')
            for submodule in $SUBMODULE_PATHS; do
              echo "Processing submodule: $submodule"
              if [ -f "$submodule/requirements.txt" ]; then
                echo "Installing Python dependencies for $submodule"
                pip install -r "$submodule/requirements.txt"
              fi
              if [ -f "$submodule/requirements.yml" ]; then
                echo "Installing Ansible dependencies for $submodule"
                ansible-galaxy install -r "$submodule/requirements.yml"
              fi
            done
          else
            echo "No submodules found."
          fi

      - name: Install podman
        run: |
          sudo apt-get install podman -y

      - name: Verify podman installation
        run: podman --version

      - name: Export environment variables
        shell: bash
        run: |
          if [ -n "${{ secrets.env_secrets }}" ]; then
            # Read each line safely
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip empty lines
              if [ -n "$line" ]; then
                printf '%s\n' "$line" >> "$GITHUB_ENV"
              fi
            done <<< "${{ secrets.env_secrets }}"
          fi

      - name: Run molecule test
        run: |
          molecule test -s ${{ inputs.scenario_name }}

...
