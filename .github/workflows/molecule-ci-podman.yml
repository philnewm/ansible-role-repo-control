---

name: molecule-ci

on:
  workflow_call:
    inputs:
      scenario_name:
        description: Scenario to run for this molecule test
        type: string
        required: true
    secrets:
      env_secrets:
        description: Custom environment setup for molecule test run
        required: false

env:
  PYTHON_VERSION: "3.12"

permissions:
  contents: read

jobs:
  molecule-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Install Ansible dependencies
        run: |
          if [ -f requirements.yml ]; then ansible-galaxy install -r requirements.yml; fi

      - name: Check for submodules and install dependencies
        shell: bash
        run: |
          # Initialize and update submodules if .gitmodules exists
          if [ -f .gitmodules ]; then
            git submodule update --init --recursive
            # Extract submodule paths from .gitmodules
            SUBMODULE_PATHS=$(git config --file .gitmodules --get-regexp path | awk '{ print $2 }')
            for submodule in $SUBMODULE_PATHS; do
              echo "Processing submodule: $submodule"
              if [ -f "$submodule/requirements.txt" ]; then
                echo "Installing Python dependencies for $submodule"
                pip install -r "$submodule/requirements.txt"
              fi
              if [ -f "$submodule/requirements.yml" ]; then
                echo "Installing Ansible dependencies for $submodule"
                ansible-galaxy install -r "$submodule/requirements.yml"
              fi
            done
          else
            echo "No submodules found."
          fi

      - name: Install podman
        run: |
          sudo apt-get install podman -y

      - name: Verify podman installation
        run: podman --version

      - name: Export environment variables
        shell: bash
        run: |
          if [ -n "${{ secrets.env_secrets }}" ]; then
            # Read each line safely
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip empty lines
              if [ -n "$line" ]; then
                printf '%s\n' "$line" >> "$GITHUB_ENV"
              fi
            done <<< "${{ secrets.env_secrets }}"
          fi

      - name: Configure podman for systemd containers
        run: |
          sudo mkdir -p /etc/containers
          sudo bash -c 'cat <<EOF > /etc/containers/containers.conf
          [engine]
          cgroup_manager = "systemd"
          events_logger = "file"
          EOF'

      - name: Run molecule test
        run: |
          sudo molecule test -s ${{ inputs.scenario_name }}

...
